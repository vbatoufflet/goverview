var app=angular.module("overview",["cfp.hotkeys","ngCookies","ngResource"]);app.config(["hotkeysProvider",function(t){t.includeCheatSheet=!1}]),app.factory("api",["$resource",function(t){return t("/api/:type/:name?",{type:"@type",name:"@name"},{get:{method:"GET",params:{type:"@type",name:"@name"}},list:{method:"GET",params:{type:"@type",name:null},isArray:!0},search:{method:"POST",params:{type:"search",name:null},isArray:!0}})}]),app.controller("MainController",["$scope","$cookies","$interval","$timeout","hotkeys","api",function(t,e,o,n,a,r){function i(t){var e=-1;return angular.forEach(t,function(t){t.state>e&&(e=t.state)}),e}t.loading=!0,t.data=[],t.nodes=[],t.groups=[],t.services=[],t.filter="",t.filterShow=!1,t.tooltip={},t.tooltipShow=!1,t.paneShow=!1,t.getService=function(t,e){var o=null;return angular.forEach(t.services,function(t){t.name===e&&(o=t)}),o},t.refresh=function(){r.list({type:"nodes"},function(e){t.nodes=e}),r.list({type:"groups"},function(e){t.groups=e}),r.search(t.query,function(e){var o,n,a,r={},l=[],s=[],c=0;a=moment().subtract(1,"minute"),angular.forEach(e,function(t){var e;t.state_new=moment(t.state_changed).isAfter(a),e=0!==t.state?t.state+3:i(t.services),r[e]||(r[e]=[]),r[e].push(t),angular.forEach(t.services,function(t){t.state_new=moment(t.state_changed).isAfter(a),-1==s.indexOf(t.name)&&s.push(t.name)}),c+=0!==t.state?1:t.services.length}),t.services=s,o=Object.keys(r),o.sort().reverse();for(n in o)l=l.concat(r[o[n]]);t.data=l,t.services.sort(),document.title=document.title.replace(/(\s+\([0-9]+\))?$/," ("+c+")"),t.error=!1,t.loading=!1},function(){t.services=[],t.data=[],t.error=!0,t.loading=!1})},t.resetForm=function(){t.form={nodes:[],groups:[],states:[],acknowledges:!1,downtimes:!1},t.query=null},t.setTooltip=function(e,o,a){if("mouseleave"==e.type){if(e.relatedTarget===t.tooltip.target)return;return t.tooltipTimeout&&n.cancel(t.tooltipTimeout),void(0===$(e.relatedTarget).closest(".tooltip").length&&(t.tooltipShow=!1,t.tooltip.target=null))}e.target!==t.tooltip.target&&(t.tooltipTimeout&&n.cancel(t.tooltipTimeout),t.tooltipTimeout=n(function(){var n,r,i,l;r=a?a:o,i=moment(r.state_changed),t.tooltipShow=!0,t.tooltip.target=e.target,t.tooltip.changed=i.format("lll"),t.tooltip.changed_relative=i.fromNow(),t.tooltip.node=o.node,t.tooltip.acknowledges=r.acknowledges,t.tooltip.downtimes=r.downtimes,t.tooltip.links=r.links,t.tooltip.output=a?a.output:"",n=$(e.target),l=n.offset(),$("#tooltip").css({top:l.top,left:n.closest("td.host").length>0?e.clientX:l.left})},500))},t.$watch("filter",function(e,o){e!==o&&(t.filterTimeout&&n.cancel(t.filterTimeout),t.filterTimeout=n(function(){t.form.filter=e},500))}),t.$watch("form",function(){t.query=angular.extend({},t.form),t.query.states=t.query.states.length>0?t.query.states.map(function(t){return parseInt(t,10)}):[1,2,3],e.putObject("opts",t.form),t.refresh()},!0),a.add({combo:"esc",allowIn:["INPUT"],callback:function(e){e.preventDefault(),e.target.value?t.filter="":n(function(){e.target.blur()},0)}}),a.add({combo:"enter",allowIn:["INPUT"],callback:function(t){"INPUT"==t.target.tagName&&n(function(){t.target.blur()},0)}}),a.add({combo:"/",callback:function(e){e.preventDefault(),t.filterShow=!0,n(function(){$("input[name=filter]").select()},0)}}),a.add({combo:"p",callback:function(){t.paneShow=!t.paneShow}}),t.form=e.getObject("opts"),void 0===t.form&&t.resetForm(),o(t.refresh,3e4)}]);